@using System.Globalization;
@model BookMyRoomResultDTO
@{
    ViewData["Title"] = "Home";
}
<style>
    /* styles.css */
    .rooms-panel {
        background-color: #f4f4f4;
        padding: 20px;
        border-radius: 10px;
    }

    .hotel-list {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #fff;
        margin: 10px 0;
        padding: 10px;
        border: 2px solid #007BFF;
        border-radius: 10px;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    .hotel-info {
        flex: 1;
    }

        .hotel-info h4 {
            font-size: 20px;
            color: #333;
        }

    .room-count, .amount {
        font-size: 18px;
        font-weight: bold;
        color: #007BFF;
    }

    .proceed-button {
        background-color: #007BFF;
        color: #fff;
        padding: 15px 30px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        display: block;
        margin: 20px auto;
        font-size: 18px;
        text-transform: uppercase;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

</style>
<form id="frmSelectRoom" method="get" asp-area="FrontOffice" asp-controller="BookMyRoom" asp-action="SingleRoomDetails">
    <input type="hidden" id="roomId" name="roomId" value="" />
    <input type="hidden" id="Params" name="Params" value="@ViewBag.FParams" />
</form>
<form id="frmRegisterRoom" method="get" asp-area="FrontOffice" asp-controller="BookMyRoom" asp-action="RegisterCustomerDetails">
    <input type="hidden" id="BParams" name="BParams" value="" />
    <input type="hidden" id="FilterParams" name="FilterParams" value="@ViewBag.FParams" />
</form>

<!-- BEGIN: Search Section ========================================= -->
<section id="search-sec">
    <div class="container-fluid search-panel">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h2>Search</h2>
                </div>
            </div>
            <form id="frmRoomFilter" method="get" asp-area="FrontOffice" asp-controller="BookMyRoom" asp-action="ViewMoreRooms">
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label>Check-in Date</label>
                            <input asp-for="roomFilterDTO.CheckInDate" id="CheckInDate" type="text" class="form-control date-picker" placeholder="dd/mm/yyyy" />
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>Check-out Date</label>
                            <input asp-for="roomFilterDTO.CheckOutDate" id="CheckOutDate" type="text" class="form-control date-picker" placeholder="dd/mm/yyyy" />
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>Adults</label>
                            <select class="form-select" asp-for="roomFilterDTO.Adults">
                                <option>1</option>
                                <option>2</option>
                                <option>3</option>
                                <option>4</option>
                                <option>5</option>
                            </select>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>Children</label>
                            <select class="form-select" asp-for="roomFilterDTO.Children">
                                <option>(Select)</option>
                                <option>1</option>
                                <option>2</option>
                                <option>3</option>
                                <option>4</option>
                                <option>5</option>
                            </select>
                        </div>
                    </div>
                    <div class="col" style="display:none">
                        <div class="form-group">
                            <label>Rooms</label>
                            <select class="form-select" asp-for="roomFilterDTO.Rooms">
                                <option>1</option>
                                <option>2</option>
                                <option>3</option>
                                <option>4</option>
                                <option>5</option>
                            </select>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label class="d-block">&nbsp;</label>
                            <a class="btn btn-primary" onclick="$('#frmRoomFilter').submit();">Check Availability</a>

                        </div>
                    </div>
                </div>
            </form>

        </div>
    </div>
</section>
<!-- END: Search Section ========================================= -->
<!-- BEGIN: Featured Section ==================================== -->
<section id="featued-sec" class="section">
    <div class="container">
        <div class="row">


            @if (Model != null && Model.listRoomsDetailsDTO != null && Model.listRoomsDetailsDTO.Count > 0)
            {
                <div class="col-md-12">
                    <h2 class="section-title text-center">Available Rooms</h2>
                </div>
                <div class="col-md-8">
                    @foreach (var item in Model.listRoomsDetailsDTO)
                    {
                        string image = string.Empty;
                        @if (item != null && item.Images != null && item.Images != "")
                        {
                            string[] ImageData = item.Images.Split('$');
                            if (ImageData.Length > 0)
                            {

                                image = ImageData[0];

                            }
                        }
                        <div class="col-md-12">
                            <div class="rooms-panel">
                                <div class="rooms-img">
                                    <img src="@(string.IsNullOrEmpty(image) ? "assets/images/rooms/room1.jpg" : "Attachments/RoomImages/" + image)" alt="Room" class="img-fluid" />
                                </div>
                                <div class="room-discription">
                                    <div class="room-title">
                                        <h4><a href="javascript:void(0);" onclick="openEditMode(@item.RoomId)">@item.RoomNumber</a></h4>
                                    </div>
                                    <div class="">
                                        <p><b>@item.RoomType</b></p>
                                        @item.BedType
                                    </div>
                                    <ul>
                                        @if (@item?.CancelationCharge != "")
                                        {
                                            <li><i class="fas fa-check"></i>@item?.CancelationCharge</li>
                                        }
                                        @if (@item?.Payment != "")
                                        {
                                            <li><i class="fas fa-check"></i>@item?.Payment</li>
                                        }
                                    </ul>
                                    <div class="pricing-details">
                                        @{
                                            // Assuming ViewBag.CheckIn and ViewBag.CheckOut are in the format "dd/mm/yyyy"
                                            DateTime? checkInDate = DateTime.ParseExact(Model?.roomFilterDTO?.CheckInDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
                                            DateTime? checkOutDate = DateTime.ParseExact(Model?.roomFilterDTO?.CheckOutDate, "dd/MM/yyyy", CultureInfo.InvariantCulture);
                                            TimeSpan? timeSpan = checkOutDate - checkInDate;
                                            int? days = timeSpan?.Days;

                                            double TotalPrice = Convert.ToDouble((item?.Rate * days));
                                            double tax = TotalPrice * 0.05;
                                            tax = Math.Round(tax, 2);

                                        }
                                        <p>@days days @(item?.MaxOccupancy > 0 ? item.MaxOccupancy + "adults" : "")   @(item?.MaxChild > 0 ? item.MaxChild + "child" : "")</p>
                                        @if (item?.Discount > 0)
                                        {
                                            <h5><strike>@item?.Rate</strike> ₹ @item?.Discount</h5>
                                        }
                                        else
                                        {
                                            <h5>@TotalPrice</h5>
                                        }

                                        <p>+ ₹ @tax taxes and charges</p>
                                    </div>
                                    <select class="select2 roomselection" data-attr="@item.RoomNumber" data-amount="@TotalPrice" data-roomid="@item.RoomId">
                                        <option value="">select</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="col-md-4">
                    <div class="rooms-panel" id="bookingInfo">
                        <h4 class="">No Room Selected </h4>
                    </div>
                </div>

            }
            else
            {
                <div class="col-md-12">
                    <h2 class="section-title text-center">No Rooms Available For Selected Date.</h2>
                </div>
            }


        </div>
    </div>
</section>
<!-- END: Featured Section ==================================== -->

<partial name="_DatepickerPartial" />
<script src="~/assets/js/ajaxconnector.js"></script>

<script>

    function openEditMode(itemId) {
        // Set the value of the hidden input field
        $('#roomId').val(itemId);
        // Submit the form
        $('#frmSelectRoom').submit();
    }

    function ViewMoreRoom() {
        $('#frmviewRoom').submit();
    }

    // Initialize the CheckInDate datepicker
    $('#CheckInDate').datepicker({
        orientation: "left",
        autoclose: true,
        format: 'dd/mm/yyyy',
        startDate: new Date(),
        todayBtn: false,
        todayHighlight: true,
    }).datepicker("setDate", "0").on('changeDate', function (ev) {
        // When the CheckInDate changes, update the start date of CheckOutDate
        var selectedDate = new Date(ev.date);
        var selectedCheckOutDate = $('#CheckOutDate').datepicker('getDate');
        var selectedDate = new Date(ev.date);
        selectedDate.setDate(selectedDate.getDate() + 1); // Add one day

        // Check if the selected CheckOutDate is lower than CheckInDate
        if (selectedCheckOutDate < selectedDate) {
            // If it's lower, set CheckOutDate to CheckInDate
            $('#CheckOutDate').datepicker('setDate', selectedDate);
        }
        $('#CheckOutDate').datepicker('setStartDate', selectedDate);

    });
    // Calculate tomorrow's date
    var tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    $('#CheckOutDate').datepicker({
        orientation: "left",
        autoclose: true,
        format: 'dd/mm/yyyy',
        todayBtn: false,
        todayHighlight: true,
        startDate: tomorrow,
    }).datepicker("setDate", tomorrow);

    var SelectedRooms = [];
    $(".roomselection").change(function () {
        SelectedRooms = [];
        // Find the select element with the "roomselection" class
        $(".roomselection").each(function () {
            var selectElement = $(this);
            var selectedOption = selectElement.find("option:selected");
            var selectedValue = parseInt(selectedOption.val());
            var dataAttrValue = selectElement.data("attr");
            var dataamount = parseFloat(selectElement.data("amount"));
            var roomId = parseFloat(selectElement.data("roomid"));

            if (selectedValue > 0) {
                SelectedRooms.push({
                    "Name": dataAttrValue,
                    "Count": selectedValue,
                    "Amount": dataamount,
                    "RoomId": roomId
                });
            }
        });
        BindBookings();
    });

    function BindBookings() {
        // Clear the previous content in the div
        $("#bookingInfo").empty();

        // Loop through the SelectedRooms array and create a div for each data entry
        for (var i = 0; i < SelectedRooms.length; i++) {
            var dataEntry = SelectedRooms[i];
            // Create a div element
            var div = '<div class="hotel-list"><div class="hotel-info">' +
                '<h4>' + dataEntry.Name + '</h4></div><div class="room-info" ><div class="room-count">' +
                'Rooms: ' + dataEntry.Count + '</div><div class="amount" >Amount:' + (dataEntry.Amount * dataEntry.Count) + '</div></div></div>';
            // Append the div to the bookingInfo div
            $("#bookingInfo").append(div);
        }
        if (SelectedRooms.length > 0) {
            var btndesign = '<button class="proceed-button" onclick="ProceedNext()" > Proceed </button>'
            $("#bookingInfo").append(btndesign);
        }
        else {
            var norecorddesign = '<h4 class=""  >No Room Selected </h4>';
            $("#bookingInfo").append(norecorddesign);
        }
    }

    const ProceedNext = async () => {
        var data = {
            finalBookingDetails: SelectedRooms
        }
        var result = await APIPostMethod('/process-data', data)

        if (result != null) {
            $('#BParams').val(result);
            $('#frmRegisterRoom').submit();
        }
    }
    if (@Model?.roomFilterDTO?.CheckInDate != "") {
        $('#CheckInDate').datepicker('setDate', '@Model?.roomFilterDTO?.CheckInDate').trigger('change');
    }
    if (@Model?.roomFilterDTO?.CheckOutDate!= "") {
        $('#CheckOutDate').datepicker('setDate', '@(Model?.roomFilterDTO?.CheckOutDate)');
    }
</script>
